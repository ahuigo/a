---
title: 延迟队列-多层次时间轮算法
date: 2020-10-31
private: true
---
# 延迟队列-多层次时间轮算法
参考：
1. https://my.oschina.net/u/4662964/blog/4617173
2. 简单说说Kafka中的时间轮算法 https://my.oschina.net/anur/blog/2252539


算法核心：
1. 就像时、分、秒指针一样，将task 分配到多层环中的桶中, 每个桶放一个双向链接用于存放task
2. 每走一个时间刻度（tick），就处理一下对应的桶（bucket）中的task list
3. 低层时间轮走完一轮后，要处理高层的时间轮
3. 上层的时间轮过期后，重新添加自然就到下层时间轮里面去了。比如最上层是以一小时为最小槽，那么当它不足一小时，就会过期，就被“执行”，执行的逻辑都是重新扔进时间轮，只有扔不进去的才会被worker线程真正执行（也就是最底层的时间轮）


时间轮定时器的优点：
1. task的添加与移除，都是O(1)级的复杂度；
2. 处理bucket 中的task list时，时间复杂度和list 长度有关
3. 适合时间跨度大的task
2. 不会占用大量的资源, 只需要有一个线程去推进时间轮就可以工作了。